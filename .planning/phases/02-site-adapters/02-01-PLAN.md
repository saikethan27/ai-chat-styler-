---
plan_id: 02-01
phase: 02
wave: 1
title: Create Gemini Adapter
objective: Create content/adapters/gemini.js with verified DOM selectors and thinking state handling
autonomous: true
depends_on: []
files_modified:
  - content/adapters/gemini.js
---

# Plan 02-01: Create Gemini Adapter

## Objective
Create Gemini adapter using verified selectors from web_elements.md with special handling for thinking states and Shadow DOM.

## Context
- Gemini uses custom elements like `code-block`
- Has "thinking" â†’ "done" transitions
- Uses Shadow DOM in some components
- Verified selectors available in web_elements.md

## Tasks

### Task 1: Create content/adapters/gemini.js
**Type:** implementation
**File:** content/adapters/gemini.js

Create adapter with:
- name: 'gemini'
- hostMatch: /gemini\.google\.com/
- responseContainerSelector from verified selectors
- selectors for headings, code blocks, tables, lists
- detectDarkMode function
- handleThinkingState option
- excludeSelectors for non-markdown content

Adapter structure:
```javascript
const geminiAdapter = {
  name: 'gemini',
  hostMatch: /gemini\.google\.com/,

  // Main container for markdown content
  responseContainerSelector: 'structured-content-container .markdown.markdown-main-panel, .message-content .markdown',

  // Selectors for markdown elements
  selectors: {
    headings: 'h1, h2, h3',
    codeBlocks: 'code-block pre code.code-container, .formatted-code-block-internal-container code',
    tables: 'table-block table, .table-content table',
    lists: 'ol[start], ul'
  },

  // Elements to exclude from processing
  excludeSelectors: [
    '.thinking-block', // Exclude during thinking state
    '.placeholder-content'
  ],

  // Detect dark mode on Gemini
  detectDarkMode() {
    // Check for dark mode class or computed style
    const isDark = document.body.classList.contains('dark-theme') ||
                   document.documentElement.classList.contains('dark-theme') ||
                   window.matchMedia('(prefers-color-scheme: dark)').matches;
    return isDark;
  },

  // Special handling for thinking state
  handleThinkingState: true,

  // Detect if element is in thinking state
  isThinking(element) {
    return element.closest('.thinking-block') !== null ||
           element.querySelector('.thinking-indicator') !== null;
  },

  // Wait for thinking to complete before applying final styling
  async waitForThinkingComplete(element, timeout = 30000) {
    if (!this.isThinking(element)) return;

    return new Promise((resolve) => {
      const observer = new MutationObserver((mutations) => {
        if (!this.isThinking(element)) {
          observer.disconnect();
          resolve();
        }
      });

      observer.observe(element, {
        childList: true,
        subtree: true,
        attributes: true
      });

      // Timeout fallback
      setTimeout(() => {
        observer.disconnect();
        resolve();
      }, timeout);
    });
  },

  // Handle Shadow DOM components
  async getShadowContent(element) {
    // Some Gemini components use Shadow DOM
    if (element.shadowRoot) {
      return element.shadowRoot.innerHTML;
    }
    return null;
  }
};

export default geminiAdapter;
```

### Task 2: Verify adapter structure
**Type:** verification

Validate:
- [ ] All selectors match verified selectors from web_elements.md
- [ ] Adapter exports correct interface
- [ ] Dark mode detection works for Gemini

## Verification Criteria

- [ ] content/adapters/gemini.js exists and exports valid adapter
- [ ] All selectors match verified selectors
- [ ] Thinking state handling implemented

## must_haves (for goal-backward verification)

1. Gemini adapter uses verified DOM selectors
2. Adapter handles thinking vs done states differently
3. Shadow DOM components handled correctly
