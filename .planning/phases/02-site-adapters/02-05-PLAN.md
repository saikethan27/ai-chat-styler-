---
plan_id: 02-05
phase: 02
wave: 3
title: Add Console Logging and Visual Indicators
objective: Add comprehensive logging and visual indicators for verification and debugging
autonomous: true
depends_on: ['02-03']
files_modified:
  - content/inject.js
  - content/adapters/gemini.js
  - content/adapters/kimi.js
  - content/adapters/generic.js
  - popup/popup.js
---

# Plan 02-05: Add Console Logging and Visual Indicators

## Objective
Add comprehensive console logging and visual indicators to verify the extension is working correctly and help with debugging.

## Context
- Console logging: Extension logs when it finds containers, applies styling, detects dark mode
- Visual indicators: Subtle borders or badges showing which elements are styled
- Popup status: Shows 'Active on [site]' with markdown container count
- Testing tool: Use Vercel's agent-browser CLI for automated browser testing

## Tasks

### Task 1: Add logging utility to inject.js
**Type:** implementation
**File:** content/inject.js

Add logging utility:
```javascript
// Logging utility with levels
const LOG_PREFIX = '[Claude UI Extension]';

const logger = {
  debug: (...args) => {
    if (window.CLAUDE_UI_DEBUG) {
      console.debug(LOG_PREFIX, ...args);
    }
  },
  info: (...args) => console.info(LOG_PREFIX, ...args),
  log: (...args) => console.log(LOG_PREFIX, ...args),
  warn: (...args) => console.warn(LOG_PREFIX, ...args),
  error: (...args) => console.error(LOG_PREFIX, ...args),

  // Group related logs
  group: (label) => console.group(LOG_PREFIX, label),
  groupEnd: () => console.groupEnd(),

  // Table output for structured data
  table: (data) => console.table(data),

  // Count occurrences
  count: (label) => console.count(`${LOG_PREFIX} ${label}`),
  countReset: (label) => console.countReset(`${LOG_PREFIX} ${label}`)
};

// Enable debug mode via localStorage or URL param
function checkDebugMode() {
  const urlParams = new URLSearchParams(window.location.search);
  window.CLAUDE_UI_DEBUG =
    localStorage.getItem('CLAUDE_UI_DEBUG') === 'true' ||
    urlParams.has('claude-ui-debug');

  if (window.CLAUDE_UI_DEBUG) {
    logger.info('Debug mode enabled');
  }
}

checkDebugMode();
```

### Task 2: Add visual indicator styles
**Type:** implementation
**File:** content/inject.js

Add CSS for visual indicators (inject as style element):
```javascript
function injectVisualIndicatorStyles() {
  const styleId = 'claude-ui-visual-indicators';
  if (document.getElementById(styleId)) return;

  const style = document.createElement('style');
  style.id = styleId;
  style.textContent = `
    /* Visual indicator for styled containers */
    .claude-ui-styled {
      position: relative;
    }

    /* Subtle left border indicator */
    .claude-ui-styled::before {
      content: '';
      position: absolute;
      left: -4px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #d97757 0%, #e8956c 100%);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .claude-ui-styled:hover::before {
      opacity: 1;
    }

    /* Badge showing extension is active */
    .claude-ui-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #d97757;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-family: system-ui, -apple-system, sans-serif;
      z-index: 10000;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .claude-ui-badge.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Debug mode: always show indicators */
    .claude-ui-debug .claude-ui-styled::before {
      opacity: 1 !important;
    }

    /* Debug outlines */
    .claude-ui-debug .claude-ui-styled {
      outline: 1px dashed #d97757;
      outline-offset: 2px;
    }

    .claude-ui-debug .claude-ui-heading {
      outline: 1px solid #4a9eff;
    }

    .claude-ui-debug .claude-ui-code {
      outline: 1px solid #50c878;
    }

    .claude-ui-debug .claude-ui-table {
      outline: 1px solid #ffd700;
    }

    .claude-ui-debug .claude-ui-list {
      outline: 1px solid #ff6b6b;
    }
  `;

  document.head.appendChild(style);
  logger.debug('Visual indicator styles injected');
}
```

### Task 3: Add status badge
**Type:** implementation
**File:** content/inject.js

Add status badge functionality:
```javascript
let statusBadge = null;
let styledContainerCount = 0;

function createStatusBadge() {
  if (statusBadge) return;

  statusBadge = document.createElement('div');
  statusBadge.className = 'claude-ui-badge';
  statusBadge.textContent = 'Claude UI Active';
  document.body.appendChild(statusBadge);

  logger.debug('Status badge created');
}

function updateStatusBadge() {
  if (!statusBadge) return;

  const adapter = currentAdapter?.name || 'unknown';
  const count = styledContainerCount;
  const darkMode = currentAdapter?.detectDarkMode?.() ? 'Dark' : 'Light';

  statusBadge.textContent = `Claude UI: ${adapter} (${count}) ${darkMode}`;
  statusBadge.classList.add('visible');

  // Hide after 5 seconds unless in debug mode
  if (!window.CLAUDE_UI_DEBUG) {
    setTimeout(() => {
      statusBadge?.classList.remove('visible');
    }, 5000);
  }
}

function showStatusBadge() {
  statusBadge?.classList.add('visible');
}
```

### Task 4: Update applyStyling with logging
**Type:** implementation
**File:** content/inject.js

Update applyStyling function with comprehensive logging:
```javascript
function applyStyling() {
  if (!currentAdapter) {
    logger.warn('No adapter selected');
    return;
  }

  logger.group('Applying styling');
  logger.info('Adapter:', currentAdapter.name);
  logger.info('Selector:', currentAdapter.responseContainerSelector);

  const containers = document.querySelectorAll(currentAdapter.responseContainerSelector);
  logger.info('Found containers:', containers.length);

  let styledCount = 0;
  let skippedCount = 0;

  containers.forEach((container, index) => {
    // Skip if already styled
    if (container.classList.contains('claude-ui-styled')) {
      logger.debug(`Container ${index}: already styled`);
      skippedCount++;
      return;
    }

    // Skip excluded elements
    if (isExcluded(container)) {
      logger.debug(`Container ${index}: excluded`);
      skippedCount++;
      return;
    }

    // Validate container (generic adapter)
    if (currentAdapter.validateContainer && !currentAdapter.validateContainer(container)) {
      logger.debug(`Container ${index}: failed validation`);
      skippedCount++;
      return;
    }

    logger.info(`Container ${index}: styling...`);

    // Handle thinking state for Gemini
    if (currentAdapter.handleThinkingState && currentAdapter.isThinking?.(container)) {
      logger.info(`Container ${index}: waiting for thinking to complete`);
      currentAdapter.waitForThinkingComplete(container).then(() => {
        logger.info(`Container ${index}: thinking complete, applying styling`);
        applyStylingToContainer(container);
        styledCount++;
        updateCounts();
      });
      return;
    }

    // Handle streaming for Kimi
    if (currentAdapter.isStreaming?.(container)) {
      logger.info(`Container ${index}: waiting for streaming to complete`);
      currentAdapter.waitForStreamingComplete(container).then(() => {
        logger.info(`Container ${index}: streaming complete, applying styling`);
        applyStylingToContainer(container);
        styledCount++;
        updateCounts();
      });
      return;
    }

    applyStylingToContainer(container);
    styledCount++;
  });

  logger.info('Styled:', styledCount, 'Skipped:', skippedCount);
  logger.groupEnd();

  styledContainerCount += styledCount;
  updateStatusBadge();
}

function updateCounts() {
  styledContainerCount = document.querySelectorAll('.claude-ui-styled').length;
  updateStatusBadge();
}

function applyStylingToContainer(container) {
  logger.debug('Styling container:', container);

  // Add styled class
  container.classList.add('claude-ui-styled');

  // Apply dark mode detection
  const isDark = currentAdapter.detectDarkMode?.() || false;
  logger.debug('Dark mode detected:', isDark);

  if (isDark) {
    container.classList.add('claude-ui-dark');
  } else {
    container.classList.remove('claude-ui-dark');
  }

  // Style specific elements based on adapter selectors
  const { selectors } = currentAdapter;
  if (selectors) {
    // Style headings
    if (selectors.headings) {
      const headings = container.querySelectorAll(selectors.headings);
      headings.forEach(el => el.classList.add('claude-ui-heading'));
      if (headings.length) logger.debug('Styled headings:', headings.length);
    }

    // Style code blocks
    if (selectors.codeBlocks) {
      const codeBlocks = container.querySelectorAll(selectors.codeBlocks);
      codeBlocks.forEach(el => el.classList.add('claude-ui-code'));
      if (codeBlocks.length) logger.debug('Styled code blocks:', codeBlocks.length);
    }

    // Style tables
    if (selectors.tables) {
      const tables = container.querySelectorAll(selectors.tables);
      tables.forEach(el => el.classList.add('claude-ui-table'));
      if (tables.length) logger.debug('Styled tables:', tables.length);
    }

    // Style lists
    if (selectors.lists) {
      const lists = container.querySelectorAll(selectors.lists);
      lists.forEach(el => el.classList.add('claude-ui-list'));
      if (lists.length) logger.debug('Styled lists:', lists.length);
    }
  }

  // Apply site-specific enhancements
  if (typeof applySiteEnhancements === 'function') {
    applySiteEnhancements(container);
  }
}
```

### Task 5: Update popup to show status
**Type:** implementation
**File:** popup/popup.js

Update popup to show active status:
```javascript
// Get current tab info
document.addEventListener('DOMContentLoaded', async () => {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  if (tab) {
    const hostname = new URL(tab.url).hostname;
    document.getElementById('current-site').textContent = hostname;

    // Query content script for status
    try {
      const response = await chrome.tabs.sendMessage(tab.id, { action: 'getStatus' });
      updatePopupStatus(response);
    } catch (e) {
      // Content script not loaded or no response
      document.getElementById('status').textContent = 'Not active on this page';
    }
  }
});

function updatePopupStatus(status) {
  if (!status) return;

  const statusEl = document.getElementById('status');
  const adapterEl = document.getElementById('adapter');
  const containersEl = document.getElementById('containers');
  const darkModeEl = document.getElementById('dark-mode');

  if (status.active) {
    statusEl.textContent = 'Active';
    statusEl.className = 'status-active';
    adapterEl.textContent = status.adapter || 'Unknown';
    containersEl.textContent = status.containerCount || 0;
    darkModeEl.textContent = status.darkMode ? 'Yes' : 'No';
  } else {
    statusEl.textContent = 'Not active';
    statusEl.className = 'status-inactive';
  }
}

// Listen for messages from content script
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'statusUpdate') {
    updatePopupStatus(message.status);
  }
});
```

### Task 6: Add message handler to inject.js
**Type:** implementation
**File:** content/inject.js

Add message handler for popup communication:
```javascript
// Listen for messages from popup
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'getStatus') {
    const status = {
      active: !!currentAdapter,
      adapter: currentAdapter?.name,
      containerCount: document.querySelectorAll('.claude-ui-styled').length,
      darkMode: currentAdapter?.detectDarkMode?.() || false,
      url: window.location.href,
      hostname: window.location.hostname
    };

    logger.debug('Status requested:', status);
    sendResponse(status);
  }

  if (request.action === 'enableDebug') {
    window.CLAUDE_UI_DEBUG = true;
    localStorage.setItem('CLAUDE_UI_DEBUG', 'true');
    document.body.classList.add('claude-ui-debug');
    showStatusBadge();
    sendResponse({ debug: true });
  }

  if (request.action === 'disableDebug') {
    window.CLAUDE_UI_DEBUG = false;
    localStorage.setItem('CLAUDE_UI_DEBUG', 'false');
    document.body.classList.remove('claude-ui-debug');
    sendResponse({ debug: false });
  }

  return true; // Keep channel open for async
});
```

### Task 7: Update initialization
**Type:** implementation
**File:** content/inject.js

Update init function:
```javascript
function init() {
  logger.group('Initializing Claude UI Extension');

  // Inject visual styles
  injectVisualIndicatorStyles();

  // Create status badge
  createStatusBadge();

  // Select adapter for current site
  currentAdapter = selectAdapter();

  if (!currentAdapter) {
    logger.error('No adapter found');
    logger.groupEnd();
    return;
  }

  logger.info('Selected adapter:', currentAdapter.name);

  // Check if adapter should activate on this page
  if (!shouldActivate()) {
    logger.info('Adapter not activating on this page');
    logger.groupEnd();
    return;
  }

  logger.info('Adapter activating');

  // Apply debug mode class if enabled
  if (window.CLAUDE_UI_DEBUG) {
    document.body.classList.add('claude-ui-debug');
  }

  // Apply initial styling
  applyStyling();

  // Set up mutation observer for dynamic content
  observeChanges();

  // Show status badge
  updateStatusBadge();

  logger.groupEnd();
}
```

## Verification Criteria

- [ ] Console logging shows adapter selection
- [ ] Console logging shows container discovery
- [ ] Console logging shows styling application
- [ ] Visual indicators appear on hover (or always in debug mode)
- [ ] Status badge shows adapter name and container count
- [ ] Popup shows active status and container count
- [ ] Debug mode can be enabled via localStorage or URL param

## must_haves (for goal-backward verification)

1. Console logs when extension finds containers
2. Console logs when styling is applied
3. Console logs dark mode detection result
4. Visual indicators (subtle borders) on styled elements
5. Status badge visible on page load
6. Popup shows 'Active on [site]' with container count
7. Debug mode available for troubleshooting
