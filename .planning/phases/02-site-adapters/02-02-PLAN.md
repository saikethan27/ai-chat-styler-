---
plan_id: 02-02
phase: 02
wave: 1
title: Create Kimi Adapter
objective: Create content/adapters/kimi.js with verified DOM selectors
autonomous: true
depends_on: []
files_modified:
  - content/adapters/kimi.js
---

# Plan 02-02: Create Kimi Adapter

## Objective
Create Kimi adapter using verified selectors from web_elements.md for kimi.ai.

## Context
- Kimi uses `.segment` classes for message organization
- Assistant responses are in `.segment.segment-assistant`
- Markdown content is in `.markdown-container`
- Verified selectors available in web_elements.md

## Tasks

### Task 1: Create content/adapters/kimi.js
**Type:** implementation
**File:** content/adapters/kimi.js

Create adapter with:
- name: 'kimi'
- hostMatch: /kimi\.ai/
- responseContainerSelector from verified selectors
- selectors for headings, code blocks, tables, lists
- detectDarkMode function
- excludeSelectors for non-markdown content

Adapter structure:
```javascript
const kimiAdapter = {
  name: 'kimi',
  hostMatch: /kimi\.ai/,

  // Main container for markdown content in assistant responses
  responseContainerSelector: '.segment.segment-assistant .markdown-container',

  // Selectors for markdown elements
  selectors: {
    headings: 'h1, h2, h3',
    codeBlocks: '.segment-code, pre code.segment-code-inline, .syntax-highlighter.segment-code-content',
    tables: '.table.markdown-table table, .table-container table',
    lists: 'ul[start], ol[start]'
  },

  // Elements to exclude from processing
  excludeSelectors: [
    '.segment-user', // User messages
    '.loading-indicator',
    '.placeholder-content'
  ],

  // Detect dark mode on Kimi
  detectDarkMode() {
    // Check for dark mode class or computed style
    const isDark = document.body.classList.contains('dark') ||
                   document.body.classList.contains('dark-mode') ||
                   document.documentElement.classList.contains('dark') ||
                   document.documentElement.getAttribute('data-theme') === 'dark' ||
                   window.matchMedia('(prefers-color-scheme: dark)').matches;
    return isDark;
  },

  // Kimi-specific: Get all assistant response containers
  getAllResponseContainers() {
    return document.querySelectorAll(this.responseContainerSelector);
  },

  // Kimi-specific: Check if content is still streaming
  isStreaming(container) {
    return container.closest('.segment')?.classList.contains('streaming') ||
           container.querySelector('.streaming-indicator') !== null;
  },

  // Wait for streaming to complete
  async waitForStreamingComplete(container, timeout = 30000) {
    if (!this.isStreaming(container)) return;

    return new Promise((resolve) => {
      const observer = new MutationObserver((mutations) => {
        if (!this.isStreaming(container)) {
          observer.disconnect();
          resolve();
        }
      });

      observer.observe(container.closest('.segment'), {
        childList: true,
        subtree: true,
        attributes: true
      });

      // Timeout fallback
      setTimeout(() => {
        observer.disconnect();
        resolve();
      }, timeout);
    });
  }
};

export default kimiAdapter;
```

### Task 2: Verify adapter structure
**Type:** verification

Validate:
- [ ] All selectors match verified selectors from web_elements.md
- [ ] Adapter exports correct interface
- [ ] Dark mode detection works for Kimi

## Verification Criteria

- [ ] content/adapters/kimi.js exists and exports valid adapter
- [ ] All selectors match verified selectors
- [ ] Streaming state detection implemented

## must_haves (for goal-backward verification)

1. Kimi adapter uses verified DOM selectors
2. Adapter correctly identifies assistant responses vs user messages
3. Streaming state handling implemented
