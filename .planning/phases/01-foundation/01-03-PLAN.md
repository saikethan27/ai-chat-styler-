---
plan_id: 01-03
phase: 01
wave: 2
title: Create Content Script Entry Point
objective: Create content/inject.js that detects site and loads appropriate adapter
autonomous: true
depends_on: ["01-01", "01-02"]
files_modified:
  - content/inject.js
  - content/adapters/generic.js
---

# Plan 01-03: Create Content Script Entry Point

## Objective
Create content/inject.js that detects the current site, loads the appropriate adapter, and injects Claude styling into markdown containers.

## Context
The content script is the main entry point that runs on every page load. It must:
1. Detect which site we're on (via hostname)
2. Load the appropriate adapter (generic.js for now, gemini/kimi later)
3. Inject claude_index.css variables into the page
4. Inject claude-markdown.css rules into the page
5. Find markdown containers using adapter selectors
6. Apply `.claude-styled` class to those containers
7. Detect dark mode and apply `.dark` class if needed

## Dependencies
- Plan 01-01 (manifest.json) must be complete so the content script is registered
- Plan 01-02 (claude-markdown.css) must be complete so styles can be injected

## Tasks

### Task 1: Create content/adapters/generic.js
**Type:** implementation
**File:** content/adapters/generic.js

Create the generic adapter that works on any site:

```javascript
// Generic adapter for universal markdown detection
const genericAdapter = {
  name: 'generic',
  hostMatch: /.*/,
  responseContainerSelector: [
    '.markdown-body',        // GitHub, many apps
    '.markdown',             // Common class
    '[class*="markdown"]',   // Fuzzy match
    '.prose',                // Tailwind prose
    '.msg-text',             // Various chat UIs
    '.message-content',      // Common pattern
    'article',               // Generic article content
  ].join(', '),
  detectDarkMode: () => {
    return window.matchMedia('(prefers-color-scheme: dark)').matches
      || document.documentElement.classList.contains('dark')
      || document.body.classList.contains('dark')
      || document.documentElement.getAttribute('data-theme') === 'dark'
      || document.body.getAttribute('data-theme') === 'dark';
  },
  excludeSelectors: [],
  initialDelayMs: 200,
};

export default genericAdapter;
```

### Task 2: Create content/inject.js
**Type:** implementation
**File:** content/inject.js

Create the main content script:

1. **Import adapter**
   - Import genericAdapter from './adapters/generic.js'
   - Create adapter registry (for future site-specific adapters)

2. **CSS Injection functions**
   - `injectCSS(url)` - Fetches CSS from extension and injects into page
   - `injectVariables()` - Injects claude_index.css
   - `injectMarkdownStyles()` - Injects claude-markdown.css

3. **Site detection**
   - `detectSite()` - Returns adapter based on hostname matching
   - For now, always returns genericAdapter

4. **Styling functions**
   - `applyStyling(container)` - Adds .claude-styled class
   - `detectAndApplyDarkMode(container)` - Adds .dark class if needed
   - `styleMarkdownContainers()` - Finds containers via adapter selector and styles them

5. **Main execution flow**
   - Wait for DOM ready (or use initialDelayMs from adapter)
   - Inject CSS variables
   - Inject markdown styles
   - Apply styling to found containers
   - Set up MutationObserver for dynamic content (basic version)

6. **MutationObserver setup**
   - Watch for new markdown containers being added
   - Debounce to avoid thrashing
   - Re-apply styling to new containers

### Task 3: Verify content script structure
**Type:** verification

Validate:
- [ ] JavaScript syntax is valid
- [ ] ES module imports/exports are correct
- [ ] Adapter pattern is extensible for future site-specific adapters
- [ ] CSS injection uses chrome.runtime.getURL for web_accessible_resources
- [ ] Error handling exists for missing containers

## Verification Criteria

- [ ] content/inject.js exists and is valid JavaScript (ES modules)
- [ ] content/adapters/generic.js exists and exports adapter config
- [ ] Content script can detect markdown containers on generic pages
- [ ] CSS variables are injected into the page
- [ ] .claude-styled class is applied to markdown containers
- [ ] Dark mode detection works
- [ ] MutationObserver is set up for dynamic content

## must_haves (for goal-backward verification)

1. Content script runs on page load without errors
2. Adapter pattern allows site-specific configurations (generic.js for now)
3. CSS (claude_index.css and claude-markdown.css) is injected into pages
4. Markdown containers are found using adapter selectors
5. .claude-styled class is applied to found containers
6. Dark mode is detected and .dark class applied appropriately
7. MutationObserver watches for new content and applies styling
